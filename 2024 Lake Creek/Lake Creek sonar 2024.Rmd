---
title: "Lake Creek Sonar 2024"
author: "Nick DeCovich"
date: "9/13/2024"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## rm(list=ls(all=TRUE))
```



## 2024 Season Summary


```{r ARIS .txt read in functions, include=FALSE, echo=FALSE}
## Read in functions and creation of objects

#The following chunk of code was provided by Carl Pfisterer and creates three functions that, together, read in ARIS .txt files

library(data.table)
############################################################
#Takes a duration string in the format H:M:S and returns duration in minutes
############################################################
DurationToNumeric = function(value){
  h = as.numeric(unlist(strsplit(value,":"))[1])
  m = as.numeric(unlist(strsplit(value,":"))[2])
  s = as.numeric(unlist(strsplit(value,":"))[3])
  d = 60*h+m+s/60
  d
}

############################################################
#Reads a single file and returns the data in a data frame.
############################################################

ReadFile = function(file){
  cat(file,"\n")
  header = readLines(file,19)
  n = as.numeric(unlist(strsplit(header[1]," "))[15])   #Extract the number of rows
  duration = unlist(strsplit(header[9]," "))[7]   #Extract the file duration
  if(n > 0){    #If there are fish in the table read it.
    data = fread(file=file,header = FALSE,sep=" ",skip=25,nrows=n)  #Must only read n rows because the file extends beyond the table of data
    data = data[,-c(13:22,27:28)]   #Remove unneeded columns
    names(data) = c("File","Total","Frame","Dir","Range","Theta","Length","dR","L/dR",
                    "Aspect","Time","Date","Pan","Tilt","Roll","Species","Q","N")
    data$Date = as.Date(data$Date)
    data$filename = file
    data$Duration = DurationToNumeric(duration)
  }
  else{         #Otherwise create a record with null values except for the file name and duration
    data = data.table(data.frame(File=NA,Total=NA,Frame=NA,Dir=NA,R=NA,Theta=NA,L=NA,dR=NA,
                                 LdR=NA,Aspect=NA,Time=NA,Date=as.Date('1970-01-01'),Pan=NA,Tilt=NA,Roll=NA,
                                 Species=NA,Q=NA,N=NA,filename=file,Duration=DurationToNumeric(duration)))
    setnames(data,c("Frame","R","L","dR","LdR"),c("Frame","Range","Length","dR","L/dR"))
  }
  data
}


############################################################
#  Reads all the files in the passed directory and appends
#  them into one data frame.
############################################################


ProcessFiles = function(dir){
  cat(paste("\nProcessing files in directory:",dir,"\n"));
  
  files = list.files(dir,recursive = TRUE, pattern=".txt$",full.names=TRUE);  #Only read files ending in .txt
  if(length(files) > 0){
    progress = txtProgressBar(style=3,min=0,max=length(files),initial=0);
    cnt = 0;
    for(file in files){
      Data = ReadFile(file);
      if(cnt==0){
        AllData = list(Data);
      }
      else{
        AllData = append(AllData,list(Data));   #Append to list of data
      }
      cnt = cnt+1;
      if((cnt%%20) == 0) setTxtProgressBar(progress,value=cnt); #Update every 20 files
    }
    setTxtProgressBar(progress,value=max(length(files)))
    AllData = setDF(rbindlist(AllData))          #combines all the tables into one large table.  data.table library must be present
  }
  else{
    AllData = NA;         #Return NA if there are no files in the directory
  }
  
  AllData
}


```

```{r source packages}
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(tidyverse)
```



```{r Read in .txt data, results=FALSE, warning=FALSE, include=FALSE, message=FALSE}

# The following chunk of code reads in the .txt files and removes the place holder necessary for files with zero counts

LakeCreek24 <- as_tibble(ProcessFiles("O:\\SF\\SALMON\\CHINOOK\\Lake Creek\\ARIS R\\2024"))
### Get rid of the 1970 placeholder generated by ReadFile function to handle files with zero fish counts
LakeCreek24 <- subset(LakeCreek24, LakeCreek24$Date!="1970-01-01")
```

The preliminary 2024 total sonar estimate of Lake Creek Chinook salmon is 2,685 fish. This includes counts of all days the sonar was operational, June 1 through July 18. on July 19 high water forced the evacuation of camp and operations ceased. A few days prior to July 11, a large school of sockeye was reported to be present by local guides. A large uptick in counts at the sonar was noted on July 11. Examination of length data showed a large proportion of fish > 750 mm, most likely Chinook, included in this uptick. It is believed that there were a substantial number of Chinook holding near the mouth along with the first wave of sockeye. Heavy rains brought up water levels starting July 11, and the two species likely ran upstream together. Using past data on Lake Creek sockeye collected at the Chelatna Lake weir, and a small sample of the 2024 sockeye run obtained by hook and line sampling, the largest Lake Creek sockeye are approximately 685 mm MEF length. Therefore, a cutoff of 750 mm total length has initially been chosen as a threshold for distinguishing a Chinook from a sockeye. This length is also used on the Kenai River and can be revisited. The estimate of fish > 750 mm for the period July 11 - 18 was 774 fish. Adding this to the June 1 through July 10 estimate for fish >= 500 mm increases the season total from 1,911 to 2,685.

This total estimate is an under count as there were likely many Chinook 500 >= 750 mm present in the final 7 days of counting. This same phenomenon happened in 2022, although to a lesser extent. Adding the final counts using a different size cutoff (750 mm vs. 500 mm), is troubling, but probably worth it as it increases the accuracy of the final passage estimate. We will next re-visit the 2022 estimates and apply a similar correction, although it will increase the final count by less (~ 200 fish).




In 2024 we had three spatial strata: 0 <= 8 M, > 8 to <= 20 M, > 20 to <= 32 M





```{r Add variables to data object and create useful subsets, results='hide', include=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
##### Create tibble with strata as variable "Strata"

LakeCreek24 <- LakeCreek24 %>%
  mutate(Strata = case_when(
    Range >= 0 & Range <= 8 ~ "Stratum1",
    Range > 8 & Range <= 20 ~ "Stratum2",      ### Check the strata designations
    Range > 20 & Range <= 32 ~ "Stratum3",
    TRUE ~ NA_character_
  ))


### Get time in correct format
LakeCreek24$Time <- as.POSIXct(LakeCreek24$Time, format = "%H:%M:%S")

LakeCreek24 <- LakeCreek24 %>%
  mutate(hour = hour(ymd_hms(Time)))


#### Expand hourly counts

LakeCreek24 <- LakeCreek24 %>%
  mutate(Expanded=(60/Duration)*File)


## object for daily counts of fish => 500 mm going down 

### Logan Note - Code did not work until adding ungroup() after the summarize() step...
LakeCreekHourlyDown <- LakeCreek24 %>%
  filter(Dir == "Down", Length >= 50) %>%
  mutate(hour = hour(ymd_hms(Time))) %>%
  group_by(Date, Strata, hour) %>%
  summarize(Expanded = sum(Expanded)) %>% ungroup()%>%
  complete(Date = seq(min(Date), max(Date), by = "day"),
           Strata, hour = 0:23, fill = list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Strata, hour, Expanded)

## Daily Expanded totals f fish => 500 mm going down
DailyExpandedTotalsDown <- LakeCreekHourlyDown %>%
  group_by(Date, Strata) %>%
  summarize(Expanded = sum(Expanded)) %>%
  ungroup() %>%
  complete(Date, Strata, fill = list(Expanded = 0))

## Daily condensed counts for fish going down  *** Need to fix this to just use min and max date...
LakeCreekDailyDown <- LakeCreekHourlyDown %>%
  group_by(Date) %>%
  summarize(Expanded = sum(Expanded)) %>%
  complete(Date = seq(as.Date("2024-06-01"), as.Date("2024-07-18"), by = "day"), fill = list(Expanded = 0)) %>%
  replace_na(list(Expanded = 0))


## Hourly counts for fish going up
LakeCreekHourly24 <- LakeCreek24 %>%
  filter(Dir == "Up", Length >= 50) %>%
  mutate(hour = hour(ymd_hms(Time))) %>%
  group_by(Date, Strata, hour) %>%
  summarize(Expanded = sum(Expanded)) %>% ungroup()%>%
  complete(Date = seq(min(Date), max(Date), by = "day"), 
           Strata, hour = 0:23, fill = list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Strata, hour, Expanded)


## Daily counts, condensed. Only has a total expanded count by date
LakeCreekDaily24 <- LakeCreekHourly24 %>%
  group_by(Date) %>%
  summarize(Expanded = sum(Expanded)) %>%
  complete(Date = seq(as.Date("2024-06-01"), as.Date("2024-07-18"), by = "day"), fill = list(Expanded = 0)) %>%
  replace_na(list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Expanded)



### Here I update the object to subtact => 500 mm fish moving down, by day. Can result in negative daily counts.THIS IS ONLY ONE TO USE FOR NOW!!!!!
LakeCreekDaily24 <- LakeCreekDaily24 %>%
  summarize(Date = Date, Expanded = (LakeCreekDaily24$Expanded - LakeCreekDailyDown$Expanded))


# Same as above, but has a row for each Strata. Inserts a zero for days/ strata with no counts. Ignores fish traveling down. 
DailyExpandedTotals <- LakeCreekHourly24 %>%
  group_by(Date, Strata) %>%
  summarize(Expanded = sum(Expanded)) %>%
  ungroup() %>%
  complete(Date, Strata, fill = list(Expanded = 0))



### Object that is simply the sum of the fish that are the size and from the dates of interest
SeasonTotal <- LakeCreekDaily24 %>%
  filter(Date >= "2024-06-01" & Date <= "2024-07-18") %>%
  summarize(sum(Expanded))
```

```{r, include=FALSE}
### this chunk calculates the daily expanded for 7/11 - 7/18 for fish => 750 mm. There is probably a tidyeR way to do this, but I created separate objects with different length/ date criteria than used above. Will look into doing this with less code in the future.

### Logan Note - Code did not work until adding ungroup() after the summarize() step...
LakeCreekHourlyDown2 <- LakeCreek24 %>%
  filter(Dir == "Down", Length >= 75) %>%
  mutate(hour = hour(ymd_hms(Time))) %>%
  group_by(Date, Strata, hour) %>%
  summarize(Expanded = sum(Expanded)) %>% ungroup()%>%
  complete(Date = seq(min(Date), max(Date), by = "day"),
           Strata, hour = 0:23, fill = list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Strata, hour, Expanded)

## Daily Expanded totals f fish => 500 mm going down
DailyExpandedTotalsDown2 <- LakeCreekHourlyDown2 %>%
  group_by(Date, Strata) %>%
  summarize(Expanded = sum(Expanded)) %>%
  ungroup() %>%
  complete(Date, Strata, fill = list(Expanded = 0))

## Daily condensed counts for fish going down  *** Need to fix this to just use min and max date...
LakeCreekDailyDown2 <- LakeCreekHourlyDown2 %>%
  group_by(Date) %>%
  summarize(Expanded = sum(Expanded)) %>%
  complete(Date = seq(as.Date("2024-07-11"), as.Date("2024-07-18"), by = "day"), fill = list(Expanded = 0)) %>%
  replace_na(list(Expanded = 0))



## Hourly counts for fish going up
LakeCreekHourly242 <- LakeCreek24 %>%
  filter(Dir == "Up", Length >= 75) %>%
  mutate(hour = hour(ymd_hms(Time))) %>%
  group_by(Date, Strata, hour) %>%
  summarize(Expanded = sum(Expanded)) %>% ungroup()%>%
  complete(Date = seq(min(Date), max(Date), by = "day"), 
           Strata, hour = 0:23, fill = list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Strata, hour, Expanded)


## Daily counts, condensed. Only has a total expanded count by date
LakeCreekDaily242 <- LakeCreekHourly242 %>%
  group_by(Date) %>%
  summarize(Expanded = sum(Expanded)) %>%
  complete(Date = seq(as.Date("2024-07-11"), as.Date("2024-07-18"), by = "day"), fill = list(Expanded = 0)) %>%
  replace_na(list(Expanded = 0)) %>%
  ungroup() %>%
  select(Date, Expanded)



### Here I update the object to subtact => 500 mm fish moving down, by day. Can result in negative daily counts.THIS IS ONLY ONE TO USE FOR NOW!!!!!
LakeCreekDaily242 <- LakeCreekDaily242 %>%
  summarize(Date = Date, Expanded = (LakeCreekDaily242$Expanded - LakeCreekDailyDown2$Expanded)) %>%
  filter(Date >= "2024-07-11" & Date <= "2024-07-18") 

SeasonTotal2 <- LakeCreekDaily242 %>%
  summarize(sum(Expanded))



```

```{r, include=FALSE}
## create object with expanded counts for 6/1 - 7/10 (fish >= 500mm) and 7/11 - 7/18 (fish >= 750mm)
 
LakeCreekDailyFinal <- LakeCreekDaily24 %>%
  filter(Date >= "2024-06-01" & Date <= "2024-07-10") %>%
  bind_rows(LakeCreekDaily242)

SeasonTotalFinal <- LakeCreekDailyFinal %>%
  summarize(sum(Expanded))

```


```{r FullSeason Total 2024, echo=FALSE}
ggplot(LakeCreekDaily24, aes(x=Date, y=Expanded)) +
  ylab("Count") +
  ggtitle("Daily expanded counts 2024") +
  geom_line() 
```




#Figure 1. Lake Creek Chinook salmon counts of fish => 500 mm,  June 1 through July 18 2024. We can see a huge uptick in counts starting July 11 due to the start of the sockeye run. 



```{r, echo=FALSE}
ggplot(LakeCreekDailyFinal, aes(x=Date, y=Expanded)) +
  ylab("Count") +
  ggtitle("Daily expanded counts 2024") +
  geom_line() 

```


#Figure 2. These are the daily counts for June 1 through July 18. June 1 - July 10 represents fish >= 500 mm, and July 11 - 18 represents fish >= 750 mm. 


```{r Expanded Daily by Strata, echo=FALSE}
ggplot(DailyExpandedTotals, aes(x=Date, y=Expanded)) +
  ylab("Date") +
  ggtitle("Daily Expanded Counts by Strata") +
  geom_line() +
  facet_grid(. ~ Strata)
```


#Figure 3. The daily counts for 2023, by strata. the large push of sockeye is seen here in the last few days in all Strata.




```{r Length by Strata, echo=FALSE}
ggplot(LakeCreek24, aes(x=Length)) +
  stat_bin(binwidth = 1) +
  geom_vline(xintercept = 50, colour = "red") +
  ylab("Count") +
  xlab("Length (cm)") +
  ggtitle("Length By Strata") +
  facet_grid(. ~ Strata)
```




#Figure 4. Length distribution by strata for Lake Creek Chinook, 2024. The red line indicates the 500 mm threshold for including counts. 



```{r, Length by Strata July, echo=FALSE}

FinalEight <- LakeCreek24 %>%
  filter(Date >= "2024-07-11" & Date <= "2024-07-18")
ggplot(FinalEight, aes(x=Length)) +
  stat_bin(binwidth = 1) +
  geom_vline(xintercept = 75, colour = "red") +
  ylab("Count") +
  xlab("Length (cm)") +
  ggtitle("Length By Strata, July 11 - 18") +
  facet_grid(. ~ Strata)
```



#Figure 5. Next we need to look at the final eight days of counting, because there were a lot of sockeye. The length distribution shows a hint of a break at ~75 cm (red line) in the third spatial strata (farthest from sonar unit), and the fish larger than this are most certainly Chinook. However, adding these large fish in to the season total creates and apples to oranges situation with the rest of the season counts. 


```{r, echo=FALSE}
ggplot(LakeCreek24, aes(x=hour)) +
  stat_bin(binwidth = 1) +
  ylab("Count") +
  xlab("hour") +
  ggtitle("count by hour")

```

#Figure 6. Interesting look at the counts by hour


#Table 1. Daily expanded counts, Wolter's successive difference model variance by date and corresponding 90% CI
for dates June 1 - July 18 2024. June 1 - July 10, fish => 500 mm. July 11 - 18 fish => 750 mm.

```{r "Logan Wolters Variance", warning=FALSE, message=FALSE, echo=FALSE, results='hide'}
# f vaies by hour, but in general should be roughly 20/60. I calculated the mean for each day 
# LakeCreek23%>%group_by(Date)%>%summarise(mean(Duration)) , and the mean is roughly 19.91. I used 20 just for ease. 

hourly <- LakeCreekHourly24 %>%
  filter(Date >= "2024-06-01" & Date <= "2024-07-18")%>%
  group_by(Date, hour) %>%
  summarize(Expanded = sum(Expanded)) %>%
  ungroup()

Results <- hourly %>%
  group_by(Date) %>%
  summarize(
    daily_expanded = sum(Expanded),
    sum_diff_sq = sum((Expanded - lag(Expanded))^2, na.rm = T),
    sum_phi = n(),
    f = 20 / 60,
    var = (24^2) * (1 - f) * (sum_diff_sq / (2 * sum_phi * (sum_phi - 1))),
    lower_ci = daily_expanded - qnorm(0.95)*sqrt(var),
    upper_ci = daily_expanded + qnorm(0.95)*sqrt(var))%>% 
  select(Date,daily_expanded, var,lower_ci,upper_ci) %>%
  mutate(daily_expanded = LakeCreekDailyFinal$Expanded)



## print.data.frame(Results)
```

```{r,results='markup',  warning=FALSE, message=FALSE, echo=FALSE}
Results2 <- Results %>%
  add_column(daily_cum = cumsum(Results$daily_expanded), cum_per = (cumsum(Results$daily_expanded))/sum(Results$daily_expanded))%>% 
  select(Date,daily_expanded, var,lower_ci,upper_ci, daily_cum, cum_per) 

print.data.frame(Results2)
```

```{r FullSeason Total 2023, echo=FALSE}
## Plot cummulatives
ggplot(Results2, aes(x=Date, y=daily_cum)) +
  ylab("Cummulative Count") +
  ggtitle("Cummulative counts 2023") +
  geom_line() 
```



#Table 2. season total count and 90% CI for dates June 1 - July 12 2023, fish => 500 mm.  

```{r "Updated Total", warning=FALSE, message=FALSE, echo=FALSE}
Totals = Results2 %>% 
  filter(Date >= "2024-06-01" & Date <= "2024-07-18")%>%
  summarize(
    df <- n() - 1,
    Total_expanded = sum(daily_expanded),
    Total_var = sum(var),
    lower_ci = Total_expanded - qnorm(0.95) * sqrt(Total_var),
    upper_ci = Total_expanded + qnorm(0.95) * sqrt(Total_var))%>%
  select(Total_expanded,Total_var,lower_ci,upper_ci)

print.data.frame(Totals)

  
```




## rmarkdown::render("Lake Creek sonar 2023 markdown.Rmd")